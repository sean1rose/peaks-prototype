<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peaks.js Segment Prototype</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 24px;
  }
  h1 { font-size: 1.4rem; margin-bottom: 16px; color: #ccc; }
  .file-selector {
    display: flex; gap: 12px; margin-bottom: 20px;
  }
  .file-selector label {
    cursor: pointer; padding: 10px 20px; border-radius: 6px;
    background: #16213e; border: 1px solid #0f3460; transition: all .15s;
  }
  .file-selector label:hover { border-color: #e94560; }
  .file-selector input:checked + span {
    color: #ff6d00;
  }
  .file-selector input { display: none; }
  #zoomview-container {
    width: 100%; height: 200px; background: #0f0f23;
    border: 1px solid #333; border-radius: 4px; margin-bottom: 8px;
  }
  #overview-container {
    width: 100%; height: 80px; background: #0f0f23;
    border: 1px solid #333; border-radius: 4px; margin-bottom: 16px;
  }
  .controls {
    display: flex; gap: 10px; margin-bottom: 16px;
  }
  .controls button {
    padding: 8px 18px; border: 1px solid #444; border-radius: 4px;
    background: #16213e; color: #e0e0e0; cursor: pointer; font-size: .9rem;
  }
  .controls button:hover { background: #1a1a4e; border-color: #e94560; }
  #status {
    font-size: .85rem; color: #888; min-height: 1.2em;
  }
</style>
</head>
<body>

<h1>Peaks.js Interactive Segment Prototype</h1>

<div class="file-selector">
  <label><input type="radio" name="file" value="ambient" checked><span>Ambient Tone (no segments)</span></label>
  <label><input type="radio" name="file" value="speech"><span>Speech Sample (pre-existing segments)</span></label>
</div>

<div id="zoomview-container"></div>
<div id="overview-container"></div>

<div class="controls">
  <button id="play-btn">Play / Pause</button>
  <button id="zoom-in">Zoom In</button>
  <button id="zoom-out">Zoom Out</button>
</div>

<p id="status">Loading…</p>

<audio id="audio" controls style="display:none"></audio>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://unpkg.com/peaks.js@3/dist/peaks.js"></script>
<script>
(function() {
  // --- Synthetic audio generation ---
  function generateAudio(type) {
    const sampleRate = 44100;
    const duration = type === 'ambient' ? 30 : 20;
    const offline = new OfflineAudioContext(1, sampleRate * duration, sampleRate);

    if (type === 'ambient') {
      // Layered sine tones with slow modulation
      [220, 330, 440].forEach(freq => {
        const osc = offline.createOscillator();
        const gain = offline.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, 0);
        gain.gain.linearRampToValueAtTime(0.15, 2);
        gain.gain.setValueAtTime(0.15, duration - 2);
        gain.gain.linearRampToValueAtTime(0, duration);
        osc.connect(gain).connect(offline.destination);
        osc.start(); osc.stop(duration);
      });
    } else {
      // Speech-like: bursts of noise + tonal segments
      const times = [
        [0.5, 3], [4, 7], [8, 10.5], [11.5, 14], [15, 18], [18.5, 19.5]
      ];
      times.forEach(([start, end]) => {
        const osc = offline.createOscillator();
        const gain = offline.createGain();
        osc.type = 'sawtooth';
        osc.frequency.value = 120 + Math.random() * 100;
        gain.gain.setValueAtTime(0, 0);
        gain.gain.setValueAtTime(0, start);
        gain.gain.linearRampToValueAtTime(0.2, start + 0.05);
        gain.gain.setValueAtTime(0.2, end - 0.05);
        gain.gain.linearRampToValueAtTime(0, end);
        osc.connect(gain).connect(offline.destination);
        osc.start(); osc.stop(duration);
      });
    }

    return offline.startRendering().then(buffer => {
      // Encode as WAV blob
      const numSamples = buffer.length;
      const data = buffer.getChannelData(0);
      const arrayBuf = new ArrayBuffer(44 + numSamples * 2);
      const view = new DataView(arrayBuf);
      function writeStr(offset, str) {
        for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
      }
      writeStr(0, 'RIFF');
      view.setUint32(4, 36 + numSamples * 2, true);
      writeStr(8, 'WAVE');
      writeStr(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeStr(36, 'data');
      view.setUint32(40, numSamples * 2, true);
      for (let i = 0; i < numSamples; i++) {
        const s = Math.max(-1, Math.min(1, data[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      }
      return URL.createObjectURL(new Blob([arrayBuf], { type: 'audio/wav' }));
    });
  }

  // --- State ---
  const audioEl = document.getElementById('audio');
  const statusEl = document.getElementById('status');
  let peaksInstance = null;
  let currentFile = 'ambient';
  const USER_SEGMENT_PREFIX = 'user-seg-';
  let userSegCount = 0;

  const preExistingSegments = [
    { startTime: 1, endTime: 3, labelText: 'Intro', color: '#2196f3', editable: true, id: 'pre-1' },
    { startTime: 5, endTime: 9, labelText: 'Main', color: '#4caf50', editable: true, id: 'pre-2' },
    { startTime: 12, endTime: 14.5, labelText: 'Closing', color: '#9c27b0', editable: true, id: 'pre-3' },
  ];

  // --- Init Peaks ---
  function init(fileType) {
    statusEl.textContent = 'Generating audio…';
    currentFile = fileType;

    if (peaksInstance) {
      peaksInstance.destroy();
      peaksInstance = null;
    }

    generateAudio(fileType).then(function(url) {
    audioEl.src = url;

    statusEl.textContent = 'Initializing waveform…';

    const options = {
      zoomview: {
        container: document.getElementById('zoomview-container'),
        waveformColor: '#e94560',
        playedWaveformColor: '#ff6d00',
      },
      overview: {
        container: document.getElementById('overview-container'),
        waveformColor: '#533483',
        playedWaveformColor: '#e94560',
      },
      mediaElement: audioEl,
      webAudio: {
        audioContext: new AudioContext(),
      },
      zoomLevels: [256, 512, 1024, 2048, 4096],
    };

    peaks.init(options, function(err, instance) {
      if (err) {
        console.error('Peaks init error:', err);
        statusEl.textContent = 'Error: ' + err.message;
        return;
      }

      peaksInstance = instance;

      // Enable insert-segment drag mode on zoomview
      const zoomview = peaksInstance.views.getView('zoomview');
      console.log('zoomview:', zoomview);
      zoomview.setWaveformDragMode('insert-segment');
      zoomview.enableSegmentDragging(true);

      // Enable dragging on overview if supported
      const overview = peaksInstance.views.getView('overview');
      if (overview && typeof overview.enableSegmentDragging === 'function') {
        overview.enableSegmentDragging(true);
      }

      // Add pre-existing segments for speech file
      if (fileType === 'speech') {
        preExistingSegments.forEach(s => peaksInstance.segments.add(s));
        console.log('All segments:', peaksInstance.segments.getSegments());
      }

      // Handle new segments from click-and-drag
      peaksInstance.on('segments.add', function(event) {
        console.log('segments.add event:', event);
        const segments = event.segments || [];
        segments.forEach(seg => {
          if (event.insert) {
            // Remove previous user-created segment
            const allSegs = peaksInstance.segments.getSegments();
            allSegs.forEach(existing => {
              if (existing.id && existing.id.startsWith(USER_SEGMENT_PREFIX) && existing.id !== seg.id) {
                peaksInstance.segments.removeById(existing.id);
              }
            });

            // Style the new user segment
            const id = USER_SEGMENT_PREFIX + (++userSegCount);
            seg.update({
              id: id,
              color: '#ff6d00',
              labelText: 'Selection',
              editable: true,
            });

            statusEl.textContent =
              'Segment: ' + seg.startTime.toFixed(2) + 's – ' + seg.endTime.toFixed(2) + 's';
          }
        });
      });

      peaksInstance.on('segments.dragend', function(event) {
        const seg = event.segment;
        statusEl.textContent =
          'Updated: ' + seg.startTime.toFixed(2) + 's – ' + seg.endTime.toFixed(2) + 's';
      });

      statusEl.textContent = 'Ready — click and drag on the zoomview to create a segment.';
    });
    }); // end generateAudio.then
  }

  // --- Controls ---
  document.getElementById('play-btn').addEventListener('click', () => {
    if (!peaksInstance) return;
    const player = peaksInstance.player;
    if (player.isPlaying()) player.pause(); else player.play();
  });

  document.getElementById('zoom-in').addEventListener('click', () => {
    if (peaksInstance) peaksInstance.zoom.zoomIn();
  });

  document.getElementById('zoom-out').addEventListener('click', () => {
    if (peaksInstance) peaksInstance.zoom.zoomOut();
  });

  document.querySelectorAll('input[name="file"]').forEach(radio => {
    radio.addEventListener('change', (e) => init(e.target.value));
  });

  // --- Start ---
  init('ambient');
})();
</script>
</body>
</html>

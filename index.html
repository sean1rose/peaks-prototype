<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Recording</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #f5f7fa;
    color: #333;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 24px;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
  }
  h1 { font-size: 1.3rem; font-weight: 600; color: #1a1a1a; }
  .close-btn {
    background: none; border: none; font-size: 1.5rem;
    color: #999; cursor: pointer; line-height: 1;
  }
  .close-btn:hover { color: #333; }
  .meta {
    display: flex; gap: 24px; margin-bottom: 20px;
    font-size: 0.9rem; color: #666;
  }
  .meta span { display: flex; align-items: center; gap: 6px; }
  .add-bookmark {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 16px; border-radius: 6px;
    background: #fff; border: 1px solid #1a3a6e;
    color: #1a3a6e; font-size: 0.85rem; font-weight: 500;
    cursor: pointer; margin-left: auto;
  }
  .add-bookmark:hover { background: #f0f4fa; }
  .toolbar {
    display: flex; align-items: center; margin-bottom: 12px;
  }
  #zoomview-container {
    width: 100%; height: 120px; background: #fff;
    margin-bottom: 20px;
  }
  .controls {
    display: flex; justify-content: center; gap: 16px;
  }
  .controls button {
    width: 44px; height: 44px; border-radius: 50%;
    border: 1px solid #ddd; background: #fff;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .controls button:hover { background: #f5f5f5; border-color: #bbb; }
  .controls button svg { width: 20px; height: 20px; fill: #555; }
  #status {
    text-align: center;
    font-size: .8rem; color: #999; margin-top: 12px;
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Call Recording</h1>
    <button class="close-btn">&times;</button>
  </div>

  <div class="meta">
    <span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      2024-11-11, 09:36:57
    </span>
    <span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      Duration: <span id="duration">00:00:00</span>
    </span>
  </div>

  <div class="toolbar">
    <button class="add-bookmark" id="add-bookmark-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
      </svg>
      ADD BOOKMARK
    </button>
  </div>

  <div id="zoomview-container"></div>

  <div class="controls">
    <button id="play-btn" title="Play/Pause">
      <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"></polygon></svg>
    </button>
    <button id="stop-btn" title="Stop">
      <svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"></rect></svg>
    </button>
    <button id="volume-btn" title="Volume">
      <svg viewBox="0 0 24 24"><polygon points="11,5 6,9 2,9 2,15 6,15 11,19"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="currentColor" stroke-width="2"></path></svg>
    </button>
  </div>

  <p id="status">Click and drag on waveform to create a bookmark</p>
</div>

<audio id="audio"></audio>

<script src="https://unpkg.com/konva@9/konva.min.js"></script>
<script src="https://unpkg.com/peaks.js@3/dist/peaks.js"></script>
<script>
(function() {
  // --- Synthetic audio generation ---
  function generateAudio(type) {
    const sampleRate = 44100;
    const duration = type === 'ambient' ? 30 : 25;
    const offline = new OfflineAudioContext(1, sampleRate * duration, sampleRate);

    if (type === 'ambient') {
      [220, 330, 440].forEach(freq => {
        const osc = offline.createOscillator();
        const gain = offline.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, 0);
        gain.gain.linearRampToValueAtTime(0.15, 2);
        gain.gain.setValueAtTime(0.15, duration - 2);
        gain.gain.linearRampToValueAtTime(0, duration);
        osc.connect(gain).connect(offline.destination);
        osc.start(); osc.stop(duration);
      });
    } else {
      const times = [
        [0.5, 3], [4, 7], [8, 10.5], [11.5, 14], [15, 18], [19, 21], [22, 24]
      ];
      times.forEach(([start, end]) => {
        const osc = offline.createOscillator();
        const gain = offline.createGain();
        osc.type = 'sawtooth';
        osc.frequency.value = 120 + Math.random() * 100;
        gain.gain.setValueAtTime(0, 0);
        gain.gain.setValueAtTime(0, start);
        gain.gain.linearRampToValueAtTime(0.2, start + 0.05);
        gain.gain.setValueAtTime(0.2, end - 0.05);
        gain.gain.linearRampToValueAtTime(0, end);
        osc.connect(gain).connect(offline.destination);
        osc.start(); osc.stop(duration);
      });
    }

    return offline.startRendering().then(buffer => {
      const numSamples = buffer.length;
      const data = buffer.getChannelData(0);
      const arrayBuf = new ArrayBuffer(44 + numSamples * 2);
      const view = new DataView(arrayBuf);
      function writeStr(offset, str) {
        for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
      }
      writeStr(0, 'RIFF');
      view.setUint32(4, 36 + numSamples * 2, true);
      writeStr(8, 'WAVE');
      writeStr(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeStr(36, 'data');
      view.setUint32(40, numSamples * 2, true);
      for (let i = 0; i < numSamples; i++) {
        const s = Math.max(-1, Math.min(1, data[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      }
      return URL.createObjectURL(new Blob([arrayBuf], { type: 'audio/wav' }));
    });
  }

  const audioEl = document.getElementById('audio');
  const statusEl = document.getElementById('status');
  const durationEl = document.getElementById('duration');
  let peaksInstance = null;
  let currentFile = 'ambient';
  const USER_SEGMENT_PREFIX = 'bookmark-';
  let userSegCount = 0;

  // Orange color matching the screenshot
  const BOOKMARK_COLOR = '#f0a030';

  const preExistingSegments = [
    { startTime: 0.5, endTime: 1.5, labelText: '1', color: BOOKMARK_COLOR, editable: true, id: 'pre-1' },
    { startTime: 2.5, endTime: 4, labelText: '2', color: BOOKMARK_COLOR, editable: true, id: 'pre-2' },
  ];

  function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return [h, m, s].map(v => String(v).padStart(2, '0')).join(':');
  }

  function init(fileType) {
    statusEl.textContent = 'Generating audio…';
    currentFile = fileType;

    if (peaksInstance) {
      peaksInstance.destroy();
      peaksInstance = null;
    }

    generateAudio(fileType).then(function(url) {
      audioEl.src = url;

      audioEl.addEventListener('loadedmetadata', function() {
        durationEl.textContent = formatTime(audioEl.duration);
      }, { once: true });

      statusEl.textContent = 'Initializing waveform…';

      const options = {
        zoomview: {
          container: document.getElementById('zoomview-container'),
          waveformColor: '#5cb85c',
          playedWaveformColor: '#5bc0de',
          axisLabelColor: '#999',
          axisGridlineColor: '#e0e0e0',
        },
        mediaElement: audioEl,
        webAudio: {
          audioContext: new AudioContext(),
        },
        zoomLevels: [256, 512, 1024, 2048, 4096],
        segmentOptions: {
          overlay: true,
          overlayColor: BOOKMARK_COLOR,
          overlayOpacity: 0.3,
          overlayBorderColor: BOOKMARK_COLOR,
          overlayBorderWidth: 2,
          overlayCornerRadius: 0,
          overlayLabelAlign: 'top-right',
          overlayLabelColor: '#fff',
          overlayLabelBackground: BOOKMARK_COLOR,
          overlayFontSize: 11,
          overlayFontFamily: 'sans-serif',
        },
      };

      peaks.init(options, function(err, instance) {
        if (err) {
          console.error('Peaks init error:', err);
          statusEl.textContent = 'Error: ' + err.message;
          return;
        }

        peaksInstance = instance;

        const zoomview = peaksInstance.views.getView('zoomview');
        zoomview.setWaveformDragMode('insert-segment');
        zoomview.enableSegmentDragging(true);

        // Add pre-existing segments
        preExistingSegments.forEach(s => peaksInstance.segments.add(s));

        peaksInstance.on('segments.add', function(event) {
          const segments = event.segments || [];
          segments.forEach(seg => {
            if (event.insert) {
              const allSegs = peaksInstance.segments.getSegments();
              allSegs.forEach(existing => {
                if (existing.id && existing.id.startsWith(USER_SEGMENT_PREFIX) && existing.id !== seg.id) {
                  peaksInstance.segments.removeById(existing.id);
                }
              });

              const id = USER_SEGMENT_PREFIX + (++userSegCount);
              seg.update({
                id: id,
                color: BOOKMARK_COLOR,
                labelText: String(userSegCount),
                editable: true,
              });

              statusEl.textContent =
                'Bookmark: ' + seg.startTime.toFixed(2) + 's – ' + seg.endTime.toFixed(2) + 's';
            }
          });
        });

        peaksInstance.on('segments.dragend', function(event) {
          const seg = event.segment;
          statusEl.textContent =
            'Updated: ' + seg.startTime.toFixed(2) + 's – ' + seg.endTime.toFixed(2) + 's';
        });

        statusEl.textContent = 'Click and drag on waveform to create a bookmark';
      });
    });
  }

  document.getElementById('play-btn').addEventListener('click', () => {
    if (!peaksInstance) return;
    const player = peaksInstance.player;
    if (player.isPlaying()) player.pause(); else player.play();
  });

  document.getElementById('stop-btn').addEventListener('click', () => {
    if (!peaksInstance) return;
    peaksInstance.player.pause();
    peaksInstance.player.seek(0);
  });

  document.getElementById('add-bookmark-btn').addEventListener('click', () => {
    if (!peaksInstance) return;
    // Remove all user-created bookmarks
    const allSegs = peaksInstance.segments.getSegments();
    allSegs.forEach(seg => {
      if (seg.id && seg.id.startsWith(USER_SEGMENT_PREFIX)) {
        peaksInstance.segments.removeById(seg.id);
      }
    });
    statusEl.textContent = 'Click and drag on waveform to create a bookmark';
  });

  init('ambient');
})();
</script>
</body>
</html>
